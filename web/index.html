<!DOCTYPE html>
<html>
<head>

<title>Temperature Lab</title>

<style>
@font-face {
    font-family: "Flamescape 7";
    font-weight: bold;
    font-style: normal;
    src: url(style/Flamescape_7-Segment_Bold.ttf);
}
@font-face {
    font-family: "Flamescape 7";
    font-weight: bold;
    font-style: italic;
    src: url(style/Flamescape_7-Segment_BoldItalic.ttf);
}
@font-face {
    font-family: "Embossing Tape";
    src: url(style/embosst1.ttf);
}

body {
    font-size: 1em;
}

h1 {
    font-family: "Embossing Tape", monospace;
    background: rgb(48, 118, 151);
    padding: 10px;
    color: white;
    font-size: 30pt;
    text-shadow:
        -2px -1px 0 rgb(48, 118, 151),  
        2px -1px 0 rgb(48, 118, 151),
        -2px 1px 0 rgb(48, 118, 151),
        2px 1px 0 rgb(0, 118, 151),
        -3px -2px 0 rgba(255,255,255,0.4),  
        3px -2px 0 rgba(255,255,255,0.4),
        -3px 2px 0 rgba(255,255,255,0.4),
        3px 2px 0 rgba(255,255,255,0.4);
    letter-spacing: 5px;
    border-radius: 3px;
    font-weight: normal;
}

.sensor {
    border: 1px dashed red;
    margin: 10px;
    padding: 10px;
}
.seven-seg {
    position: absolute;
    top: 0;
    right: 0;
    display: block;
    color: red;
    text-shadow: 0 0 10px red;
}
.seven-seg-container {
    position: relative;
    background: #222;
    color: black;
    text-align: right;
    width: 300px;
    font: bold 3em "Flamescape 7", monospace;
    text-align: right;
}
.seven-seg-container:before {
    content: attr(data-backplane);
}
.disconnected {
    background: gray;
}
</style>

<script src="jquery.js"></script>
<script src="socket.js"></script>
<script src="graph.js"></script>
<script>


var TempSensor = function(device, sensorContainer){
    this.device = device;
    this.t = null;
    this.e = {};
    this.e.container = $("<div class='sensor'/>").appendTo($("#"+sensorContainer));
    this.e.device = $("<h2/>").appendTo(this.e.container).text(device);
    this.e.value = $('<div class="seven-seg-container" data-backplane="88888.8888"><span class="seven-seg"/></div>').appendTo(this.e.container).find('span');
    this.e.graph = $("<div/>").appendTo(this.e.container);
    // graph setup
    this.dataTable = new google.visualization.DataTable();
    this.dataTable.addColumn('date', 'Time');
    this.dataTable.addColumn('number', 'Therm1');
    this.chart = new google.visualization.LineChart(this.e.graph.get(0));
}
TempSensor.prototype = {
    update: function(data) {
        var self = this;
        data.forEach(function(entry){
            self.dataTable.addRow([new Date(entry.time), entry.t]);
            if (!self.lastData || entry.time > self.lastData.time) {
                self.lastEntry = entry;
                self.t = entry.t;
                self.e.value.text(entry.t.toFixed(2)).append("&deg;C");
                self.chart.draw(self.dataTable, {curveType: "function", width: 500, height: 400, vAxis: {minValue: 0}});
            }
        });
    }
};


var TempLab = function(sensorContainer){
    var self = this;
    this.sensorContainer = sensorContainer;
    this.sensors = {};
    this.io = io.connect('ws://'+window.location.host);
    this.io.on('tData', function(data){
        self.getSensor(data.device).update(data);
    });
    this.io.on('tDisconnect', function(data) {
        self.getSensor(data.device).e.container.addClass('disconnected');
    });
    this.io.on('tConnect', function(data) {
        self.getSensor(data.device).e.container.removeClass('disconnected');
    });
}
TempLab.prototype = {
    getSensor: function(device){
        if (!!this.sensors[device])
            return this.sensors[device];
        
        this.sensors[device] = new TempSensor(device, this.sensorContainer);
        return this.sensors[device];
    }
};

google.load('visualization', '1.0', {'packages':['corechart']});
google.setOnLoadCallback(function(){
    var tl = new TempLab("sensors");
});
</script>

</head>
<body>

<h1>Temperature laboratory</h1>

<div id="sensors"></div>

</body>
</html>